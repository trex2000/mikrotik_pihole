{
    :local cName "pihole"
    :local logPrefix "Container Update:"
    :local cImage "pihole/pihole"
    :local cInterface "veth1"
    :local cRootDir "ramdisk1/images/pihole"
    :local cMounts "MOUNT_PIHOLE_PIHOLE,MOUNT_PIHOLE_DNSMASQD"
    :local cEnv "ENV_PIHOLE"

    /container

    # --- 1. CHECK STATUS FIRST ---
    # We check if the container is already running or starting
    :if ([print count-only where name=$cName (running or starting)] > 0) do={
        :log info "$($logPrefix)Container $cName is already active. No update needed. Exiting."
    } else={
        # --- 2. INSTALLATION LOGIC (Only runs if NOT active) ---
        :log info "$($logPrefix)Starting update/install process..."

        # Cleanup if it exists but is STOPPED
        :if ([print count-only where name=$cName] > 0) do={
            :log info "$($logPrefix)Removing old container..."
            remove $cName
            :while ([print count-only where name=$cName] > 0) do={ :delay 1 }
            :delay 3s
        }

        # Add new container
		add remote-image=$cImage mount=$cMounts interface=$cInterface root-dir=$cRootDir envlist=$cEnv name=$cName
	# add remote-image="pihole/pihole" interface="veth1" root-dir="ramdisk1/images/pihole" mount="MOUNT_PIHOLE_PIHOLE,MOUNT_PIHOLE_DNSMASQD" envlist="ENV_PIHOLE" name="pihole"

        # Wait for table registration
        :while ([print count-only where name=$cName] = 0) do={ :delay 1 }

        # Monitor Extraction using flags
        :log info "$($logPrefix)Waiting for extraction..."
        :local timer 0
        :while ([print count-only where name=$cName stopped] = 0 && $timer < 300) do={
            :delay 1
            :set timer ($timer + 1)
        }
		# if script exited before timer expired
        :if ($timer < 300) do={
            #stop timer
			:set timer 300
			# Final check  for 'stopped' flag to be true before starting
            :if ([print count-only where name=$cName stopped] = 1) do={
				:log info "$($logPrefix) Container extracted succesfully. Starting container..."
				:delay 2s
				start $cName
				:log info "$($logPrefix)Process complete."
				/ip firewall nat
				add action=dst-nat chain=dstnat src-address=!192.168.88.1 dst-address=192.168.88.1 dst-port=53 protocol=udp to-addresses=172.17.0.2 to-ports=53 comment="TEMP_DNS_REDIRECT_TO_PIHOLE"
				add action=dst-nat chain=dstnat src-address=!192.168.88.1 dst-address=192.168.88.1 dst-port=53 protocol=tcp to-addresses=172.17.0.2 to-ports=53 comment="TEMP_DNS_REDIRECT_TO_PIHOLE"				
				add action=dst-nat chain=dstnat src-address=!192.168.1.1 dst-address=192.168.1.1 dst-port=53 protocol=udp to-addresses=172.17.0.2 to-ports=53 comment="TEMP_DNS_REDIRECT_TO_PIHOLE"
				add action=dst-nat chain=dstnat src-address=!192.168.1.1 dst-address=192.168.1.1 dst-port=53 protocol=tcp to-addresses=172.17.0.2 to-ports=53 comment="TEMP_DNS_REDIRECT_TO_PIHOLE"
			} else={
				:log error "$($logPrefix) Pihole Status not in stopped state"
			   }		
        } else={
				:log error "$($logPrefix)Extraction timed out."
			}
            
        }
    }
}

